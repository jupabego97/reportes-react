<section class="cart-section" data-section-id="{{ section.id }}">
  <div class="cart-container">
    <header class="cart-header">
      <h1 class="cart-title">Tu carrito</h1>
      {%- if cart.item_count > 0 -%}
        <span class="cart-count">{{ cart.item_count }} {{ cart.item_count | pluralize: 'producto', 'productos' }}</span>
      {%- endif -%}
    </header>

    {%- if cart.item_count > 0 -%}
      <div class="cart-content">
        <div class="cart-items-wrapper">
          <form action="{{ routes.cart_url }}" method="post" class="cart-form" id="cart-form">
            <!-- Cabecera de tabla (desktop) -->
            <div class="cart-table-header">
              <span class="header-product">Producto</span>
              <span class="header-price">Precio</span>
              <span class="header-quantity">Cantidad</span>
              <span class="header-total">Total</span>
            </div>

            <!-- Items del carrito -->
            <div class="cart-items">
              {%- for item in cart.items -%}
                <div class="cart-item" data-cart-item data-line="{{ forloop.index }}">
                  <!-- Imagen -->
                  <div class="cart-item-image">
                    <a href="{{ item.url }}">
                      {%- if item.image -%}
                        {{ item.image | image_url: width: 200 | image_tag: loading: 'lazy', class: 'item-image' }}
                      {%- else -%}
                        <div class="item-image-placeholder">
                          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                          </svg>
                        </div>
                      {%- endif -%}
                    </a>
                  </div>

                  <!-- Info del producto -->
                  <div class="cart-item-info">
                    <div class="item-details">
                      {%- if item.product.vendor -%}
                        <span class="item-vendor">{{ item.product.vendor }}</span>
                      {%- endif -%}
                      <h3 class="item-title">
                        <a href="{{ item.url }}">{{ item.product.title }}</a>
                      </h3>
                      {%- unless item.product.has_only_default_variant -%}
                        <p class="item-variant">{{ item.variant.title }}</p>
                      {%- endunless -%}
                      {%- if item.selling_plan_allocation -%}
                        <p class="item-selling-plan">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                      {%- endif -%}
                    </div>

                    <!-- Precio (móvil) -->
                    <div class="item-price-mobile">
                      {%- if item.original_price != item.final_price -%}
                        <span class="price-compare">{{ item.original_price | money }}</span>
                      {%- endif -%}
                      <span class="price{% if item.original_price != item.final_price %} price--sale{% endif %}">
                        {{ item.final_price | money }}
                      </span>
                    </div>
                  </div>

                  <!-- Precio (desktop) -->
                  <div class="cart-item-price">
                    {%- if item.original_price != item.final_price -%}
                      <span class="price-compare">{{ item.original_price | money }}</span>
                    {%- endif -%}
                    <span class="price{% if item.original_price != item.final_price %} price--sale{% endif %}">
                      {{ item.final_price | money }}
                    </span>
                  </div>

                  <!-- Cantidad -->
                  <div class="cart-item-quantity">
                    <div class="quantity-selector">
                      <button 
                        type="button" 
                        class="quantity-btn quantity-btn--minus" 
                        data-action="decrease"
                        aria-label="Reducir cantidad"
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                      </button>
                      <input 
                        type="number" 
                        name="updates[]" 
                        value="{{ item.quantity }}" 
                        min="0"
                        data-line="{{ forloop.index }}"
                        class="quantity-input"
                        aria-label="Cantidad"
                      >
                      <button 
                        type="button" 
                        class="quantity-btn quantity-btn--plus" 
                        data-action="increase"
                        aria-label="Aumentar cantidad"
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="12" y1="5" x2="12" y2="19"/>
                          <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                      </button>
                    </div>
                    <button 
                      type="button" 
                      class="remove-item" 
                      data-action="remove"
                      aria-label="Eliminar producto"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                      </svg>
                      Eliminar
                    </button>
                  </div>

                  <!-- Total del item -->
                  <div class="cart-item-total">
                    <span class="item-line-total">{{ item.final_line_price | money }}</span>
                  </div>
                </div>
              {%- endfor -%}
            </div>
          </form>
        </div>

        <!-- Resumen del carrito -->
        <aside class="cart-summary">
          <div class="summary-card">
            <h2 class="summary-title">Resumen del pedido</h2>

            <div class="summary-rows">
              <div class="summary-row">
                <span>Subtotal</span>
                <span>{{ cart.total_price | money }}</span>
              </div>

              {%- if cart.total_discount > 0 -%}
                <div class="summary-row summary-row--discount">
                  <span>Descuento</span>
                  <span>-{{ cart.total_discount | money }}</span>
                </div>
              {%- endif -%}

              <div class="summary-row summary-row--shipping">
                <span>Envío</span>
                <span class="shipping-note">Calculado en el checkout</span>
              </div>
            </div>

            <div class="summary-total">
              <span>Total</span>
              <span class="total-price">{{ cart.total_price | money }}</span>
            </div>

            <!-- Nota del pedido -->
            {%- if section.settings.show_cart_note -%}
              <div class="cart-note">
                <label for="cart-note" class="note-label">Nota del pedido</label>
                <textarea 
                  id="cart-note" 
                  name="note" 
                  form="cart-form"
                  class="note-input"
                  placeholder="Instrucciones especiales para tu pedido..."
                >{{ cart.note }}</textarea>
              </div>
            {%- endif -%}

            <!-- Botones de acción -->
            <div class="summary-actions">
              <button type="submit" name="checkout" form="cart-form" class="btn btn--primary btn--checkout">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                  <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Finalizar compra
              </button>

              <a href="{{ routes.all_products_collection_url }}" class="btn btn--secondary btn--continue">
                Seguir comprando
              </a>
            </div>

            <!-- Métodos de pago -->
            <div class="payment-methods">
              <p>Aceptamos</p>
              <div class="payment-icons">
                {%- for type in shop.enabled_payment_types -%}
                  {{ type | payment_type_svg_tag: class: 'payment-icon' }}
                {%- endfor -%}
              </div>
            </div>

            <!-- Garantías -->
            <div class="cart-guarantees">
              <div class="guarantee-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span>Compra segura</span>
              </div>
              <div class="guarantee-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="3" width="15" height="13"/>
                  <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                  <circle cx="5.5" cy="18.5" r="2.5"/>
                  <circle cx="18.5" cy="18.5" r="2.5"/>
                </svg>
                <span>Envío rápido</span>
              </div>
              <div class="guarantee-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"/>
                  <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                <span>Devolución fácil</span>
              </div>
            </div>
          </div>
        </aside>
      </div>

    {%- else -%}
      <!-- Carrito vacío -->
      <div class="cart-empty">
        <div class="empty-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
        </div>
        <h2 class="empty-title">Tu carrito está vacío</h2>
        <p class="empty-text">Parece que aún no has agregado productos a tu carrito.</p>
        <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
          Explorar productos
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  .cart-section {
    padding: var(--space-10) 0 var(--space-16);
    background: var(--color-bg);
    min-height: 60vh;
  }

  .cart-container {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 var(--container-padding);
  }

  .cart-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--color-border);
  }

  .cart-title {
    font-family: var(--font-heading);
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
  }

  .cart-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-1) var(--space-3);
    background: var(--color-accent-light);
    color: var(--color-accent);
    font-size: var(--text-sm);
    font-weight: 600;
    border-radius: var(--radius-full);
  }

  /* Layout del carrito */
  .cart-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--space-8);
    align-items: start;
  }

  /* Tabla de items */
  .cart-table-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-5);
    background: var(--color-bg-alt);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .cart-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .cart-item {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    align-items: center;
    transition: all var(--transition-fast);
  }

  .cart-item:hover {
    border-color: var(--color-border-accent);
    box-shadow: var(--shadow-md);
  }

  .cart-item-image {
    width: 100px;
    aspect-ratio: 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
  }

  .item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
  }

  .cart-item-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .item-vendor {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .item-title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
    line-height: 1.4;
  }

  .item-title a:hover {
    color: var(--color-accent);
  }

  .item-variant,
  .item-selling-plan {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .item-price-mobile {
    display: none;
  }

  .cart-item-price {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .price {
    font-family: var(--font-heading);
    font-weight: 600;
    color: var(--color-text);
  }

  .price--sale {
    color: var(--color-error);
  }

  .price-compare {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  /* Cantidad */
  .cart-item-quantity {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-3);
  }

  .cart-item .quantity-selector {
    display: inline-flex;
    align-items: center;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-surface);
  }

  .cart-item .quantity-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-alt);
    color: var(--color-text);
    transition: all var(--transition-fast);
  }

  .cart-item .quantity-btn:hover {
    background: var(--color-accent);
    color: white;
  }

  .cart-item .quantity-input {
    width: 48px;
    height: 36px;
    text-align: center;
    font-weight: 600;
    background: var(--color-surface);
    border: none;
    color: var(--color-text);
    font-size: var(--text-base);
    -moz-appearance: textfield;
  }

  .cart-item .quantity-input::-webkit-outer-spin-button,
  .cart-item .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .remove-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .remove-item:hover {
    color: var(--color-error);
    background: var(--color-error-light);
  }

  .cart-item-total {
    text-align: right;
  }

  .item-line-total {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-accent);
  }

  /* Resumen */
  .cart-summary {
    position: sticky;
    top: 100px;
  }

  .summary-card {
    background: var(--color-surface);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--color-border);
  }

  .summary-title {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 var(--space-5);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border);
  }

  .summary-rows {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-bottom: var(--space-5);
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .summary-row--discount span:last-child {
    color: var(--color-success);
    font-weight: 600;
  }

  .shipping-note {
    color: var(--color-text-muted);
    font-size: var(--text-xs);
    font-style: italic;
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) 0;
    border-top: 2px solid var(--color-border);
    border-bottom: 2px solid var(--color-border);
    margin-bottom: var(--space-5);
  }

  .summary-total span:first-child {
    font-weight: 600;
    font-size: var(--text-lg);
    color: var(--color-text);
  }

  .total-price {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-accent);
  }

  /* Nota del carrito */
  .cart-note {
    margin-bottom: var(--space-5);
  }

  .note-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .note-input {
    width: 100%;
    padding: var(--space-4);
    background: var(--color-bg-alt);
    border: 2px solid transparent;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-family: var(--font-body);
    color: var(--color-text);
    resize: vertical;
    min-height: 80px;
    transition: all var(--transition-fast);
  }

  .note-input:focus {
    outline: none;
    border-color: var(--color-accent);
    background: var(--color-surface);
    box-shadow: 0 0 0 3px var(--color-accent-glow);
  }

  /* Acciones */
  .summary-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-bottom: var(--space-5);
  }

  .btn--checkout {
    background: var(--color-accent);
    color: white;
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
    font-weight: 600;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    transition: all var(--transition-fast);
    box-shadow: 0 4px 14px var(--color-accent-glow);
  }

  .btn--checkout:hover {
    background: var(--color-accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--color-accent-glow);
  }

  .btn--continue {
    background: var(--color-surface);
    color: var(--color-text);
    border: 2px solid var(--color-border);
    padding: var(--space-3) var(--space-6);
    font-size: var(--text-sm);
    font-weight: 600;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .btn--continue:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  /* Métodos de pago */
  .payment-methods {
    text-align: center;
    padding: var(--space-4) 0;
    border-top: 1px solid var(--color-border);
    margin-bottom: var(--space-4);
  }

  .payment-methods p {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-3);
  }

  .payment-icons {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .payment-icon {
    height: 24px;
    width: auto;
    opacity: 0.7;
  }

  /* Garantías */
  .cart-guarantees {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-bg-alt);
    border-radius: var(--radius-lg);
  }

  .guarantee-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .guarantee-item svg {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  /* Carrito vacío */
  .cart-empty {
    text-align: center;
    padding: var(--space-16) var(--space-6);
    background: var(--color-surface);
    border-radius: var(--radius-2xl);
    border: 1px solid var(--color-border);
  }

  .empty-icon {
    width: 100px;
    height: 100px;
    margin: 0 auto var(--space-6);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-alt);
    border-radius: var(--radius-full);
    color: var(--color-text-muted);
  }

  .empty-title {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 var(--space-2);
  }

  .empty-text {
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-6);
    font-size: var(--text-base);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .cart-content {
      grid-template-columns: 1fr;
    }

    .cart-summary {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .cart-section {
      padding: var(--space-6) 0 var(--space-10);
    }

    .cart-table-header {
      display: none;
    }

    .cart-item {
      grid-template-columns: 80px 1fr;
      grid-template-rows: auto auto;
      gap: var(--space-3);
      padding: var(--space-4);
    }

    .cart-item-image {
      width: 80px;
      grid-row: span 2;
    }

    .cart-item-info {
      grid-column: 2;
    }

    .item-price-mobile {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
    }

    .cart-item-price {
      display: none;
    }

    .cart-item-quantity {
      grid-column: 2;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .cart-item-total {
      display: none;
    }

    .cart-guarantees {
      grid-template-columns: 1fr;
    }

    .guarantee-item {
      flex-direction: row;
      text-align: left;
    }
  }
</style>

<script>
(function() {
  // Singleton para evitar múltiples inicializaciones
  if (window.__cartManagerInitialized) return;
  window.__cartManagerInitialized = true;

  let isUpdating = false;
  let updateTimeout = null;

  async function updateCartQuantity(line, quantity) {
    // Prevenir múltiples llamadas simultáneas
    if (isUpdating) return;
    isUpdating = true;

    // Mostrar feedback visual
    const item = document.querySelector(`[data-line="${line}"]`);
    if (item) {
      item.style.opacity = '0.5';
      item.style.pointerEvents = 'none';
    }

    try {
      const response = await fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          line: parseInt(line),
          quantity: parseInt(quantity)
        })
      });

      if (response.ok) {
        // Recargar la página para mostrar cambios
        window.location.reload();
      } else {
        const error = await response.json();
        console.error('Cart error:', error);
        alert(error.description || 'Error al actualizar el carrito');
        isUpdating = false;
        if (item) {
          item.style.opacity = '1';
          item.style.pointerEvents = 'auto';
        }
      }
    } catch (error) {
      console.error('Error updating cart:', error);
      isUpdating = false;
      if (item) {
        item.style.opacity = '1';
        item.style.pointerEvents = 'auto';
      }
    }
  }

  // Usar delegación de eventos en lugar de múltiples listeners
  document.addEventListener('click', function(e) {
    // Ignorar si ya estamos actualizando
    if (isUpdating) return;

    const target = e.target;
    
    // Botón de aumentar
    const increaseBtn = target.closest('[data-action="increase"]');
    if (increaseBtn) {
      e.preventDefault();
      e.stopPropagation();
      const cartItem = increaseBtn.closest('.cart-item');
      if (!cartItem) return;
      
      const line = cartItem.dataset.line;
      const input = cartItem.querySelector('.quantity-input');
      const newValue = (parseInt(input.value) || 0) + 1;
      input.value = newValue;
      updateCartQuantity(line, newValue);
      return;
    }

    // Botón de disminuir
    const decreaseBtn = target.closest('[data-action="decrease"]');
    if (decreaseBtn) {
      e.preventDefault();
      e.stopPropagation();
      const cartItem = decreaseBtn.closest('.cart-item');
      if (!cartItem) return;
      
      const line = cartItem.dataset.line;
      const input = cartItem.querySelector('.quantity-input');
      const newValue = Math.max(0, (parseInt(input.value) || 0) - 1);
      input.value = newValue;
      updateCartQuantity(line, newValue);
      return;
    }

    // Botón de eliminar
    const removeBtn = target.closest('[data-action="remove"]');
    if (removeBtn) {
      e.preventDefault();
      e.stopPropagation();
      const cartItem = removeBtn.closest('.cart-item');
      if (!cartItem) return;
      
      const line = cartItem.dataset.line;
      updateCartQuantity(line, 0);
      return;
    }
  }, true); // Usar capture para interceptar antes que otros handlers

  // Manejar cambios manuales en el input con debounce
  document.addEventListener('change', function(e) {
    if (isUpdating) return;
    
    const input = e.target;
    if (!input.classList.contains('quantity-input')) return;
    
    const cartItem = input.closest('.cart-item');
    if (!cartItem) return;

    e.stopPropagation();
    
    // Debounce para evitar múltiples llamadas
    if (updateTimeout) clearTimeout(updateTimeout);
    updateTimeout = setTimeout(() => {
      const line = cartItem.dataset.line;
      const quantity = parseInt(input.value) || 0;
      updateCartQuantity(line, quantity);
    }, 300);
  }, true);
})();
</script>

{% schema %}
{
  "name": "Carrito",
  "tag": "section",
  "class": "section-cart",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "Mostrar campo de nota",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Mostrar marca del producto",
      "default": true
    }
  ]
}
{% endschema %}

















